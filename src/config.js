var map = [
	[1,1,1,2,1,1,2,1,1,2,1,1,2,1,1,2,1,1,2,1,1,2,1,1,2,1,1,2,1,1,2,1,1,1],
	[1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,2],
	[1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],
	[2,0,0,1,1,1,1,2,1,0,0,0,1,1,2,1,1,1,1,2,1,1,0,0,0,1,2,1,1,1,1,0,0,1],
	[1,0,0,1,1,2,1,1,1,0,0,0,1,2,1,1,1,1,1,1,2,1,0,0,0,1,1,1,2,1,1,0,0,2],
	[1,0,0,2,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,2,0,0,1],
	[2,0,0,1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,0,0,1],
	[1,0,0,1,2,0,0,1,1,1,1,1,1,1,0,0,1,1,0,0,1,1,1,2,1,1,1,0,0,1,1,0,0,2],
	[1,0,0,1,1,0,0,1,1,1,2,1,1,1,0,0,1,1,0,0,1,1,1,2,1,1,1,0,0,2,1,0,0,1],
	[2,0,0,1,1,0,0,2,1,0,0,0,1,2,0,0,2,2,0,0,2,1,0,0,0,1,2,0,0,1,1,0,0,1],
	[1,0,0,2,1,0,0,1,1,0,0,0,1,1,0,0,1,1,0,0,1,1,0,0,0,1,1,0,0,1,1,0,0,2],
	[1,0,0,1,1,0,0,1,2,0,0,0,1,1,0,0,1,1,0,0,1,1,0,0,0,1,1,0,0,1,2,0,0,1],
	[2,0,0,1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,0,0,1],
	[1,0,0,1,2,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,0,0,2],
	[1,0,0,1,1,0,0,1,2,0,0,0,1,1,0,0,1,1,0,0,1,1,0,0,0,1,1,0,0,2,1,0,0,1],
	[2,0,0,1,1,0,0,1,1,0,0,0,1,1,0,0,1,1,0,0,1,1,0,0,0,1,1,0,0,1,1,0,0,1],
	[1,0,0,2,1,0,0,2,1,0,0,0,1,2,0,0,2,2,0,0,2,1,0,0,0,1,2,0,0,1,1,0,0,2],
	[1,0,0,1,1,0,0,1,1,1,2,1,1,1,0,0,1,1,0,0,1,1,1,2,1,1,1,0,0,1,2,0,0,1],
	[2,0,0,1,1,0,0,1,2,1,1,1,2,1,0,0,1,1,0,0,1,2,1,1,1,2,1,0,0,1,1,0,0,1],
	[1,0,0,1,2,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,2,1,0,0,2],
	[1,0,0,1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,0,0,1],
	[2,0,0,1,1,2,1,1,1,0,0,0,1,2,1,1,1,1,1,1,1,2,0,0,0,1,1,1,2,1,1,0,0,1],
	[1,0,0,1,1,1,1,2,1,0,0,0,1,1,2,1,1,1,1,1,2,1,0,0,0,1,2,1,1,1,1,0,0,2],
	[1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],
	[2,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],
	[1,1,1,2,1,1,2,1,1,2,1,1,2,1,1,2,1,1,2,1,1,2,1,1,2,1,1,2,1,1,2,1,1,1]
];
var generateImage = () => {
	var c = $("img");
	c.width = 64*2;
	c.height = 64*3;
	var tc = c.getContext("2d");
	tc.beginPath();
	tc.fillStyle="#D4E6B5";
	tc.rect(0,0,64,64*3);
	tc.fill();
	tc.beginPath();
	tc.fillStyle="#AFC97E";
	tc.rect(64,0,64*2, 64*3);
	tc.fill();
	
	for (var i=0; i <=64*3; i+=8)
	{
	  tc.beginPath();
	  tc.strokeStyle="#585123";
	  tc.moveTo(0 , i);
	  tc.lineTo(64*2, i);
	  tc.stroke();
	}  
  
	tc.beginPath();
	tc.fillStyle="#431B0F";
	tc.rect(12,64+8,64-24, 64-8);
	tc.fill();
	tc.beginPath();
	tc.rect(64+12,64+8,64-24, 64-8);
	tc.fill();
	tc.beginPath();
	tc.rect(12,(64*2)+8,64-24, 64-8);
	tc.fill();
	tc.beginPath();
	tc.rect(64+12,(64*2)+8,64-24, 64-8);
	tc.fill();
  
	tc.fillStyle="#FFA400";
	tc.font = "8px Arial";
	tc.fillText("404", 26, 84);
	tc.fillText("404", 90, 84);
	tc.fillText("200", 26, 148);
	tc.fillText("200", 90, 148);
  
	imgUrl = c.toDataURL();
}

var player = {
    x: 10,
    y: 10,
    dir: 0,
    rot: 0,
    speed: 0,
    moveSpeed: 0.1,
    rotSpeed: 6
}
var mapWidth = 0;
var mapHeight = 0;
var miniMapScale = 8;
var screenWidth = 320;
var screenHeight = 200;
var stripWidth = 2;
//2 * Math.PI is a full circle (assume radius = 1), divide by 360 to get the arc length of 1 degree (hence Math.PI/180),  multiply 60, to get arc length for 60 degrees
var fov = 60 * Math.PI / 180;
var numRays = Math.ceil(screenWidth / stripWidth);
var fovHalf = fov / 2;
//imagine an equilateral triangle (60 degrees every angle), draw a line splitting the angle in half (30 degrees) to the other side. This calculates the length of that line.
var viewDist = (screenWidth/2) / Math.tan((fov / 2));
var twoPI = Math.PI * 2;
var screenStrips = [];
var numTextures = 3;
var imgUrl = "";
//s for start, i for in progress, w for win, l for loss
var gFlag = 's';

var x200 = 0;
var y200 = 0;